# ChemDB Search

CLI tool for searching chemical databases for structurally similar molecules using ECFP4 Tanimoto similarity and optional substructure filters.

Powered by the [SmallWorld API](https://sw.docking.org) — free access to billions of purchasable compounds, no API key required.

## Features

- **Input formats**: `.sdf` and `.pdb` files with 3D coordinates
- **Batch processing**: Multi-molecule SDF files — each molecule is searched independently
- **Similarity metric**: ECFP4 Tanimoto coefficient (via SmallWorld)
- **Optional substructure filtering**: Generic (`-sub`) or exact (`-esub`), optionally from a separate file (`-sf`)
- **Stereochemistry preservation**: Chiral centers and E/Z geometry from 3D coordinates are retained throughout the pipeline
- **Output formats**: SDF files (with explicit hydrogens and MMFF-optimized 3D coordinates) and JSON
- **Multiple databases**: Enamine REAL (10.1B), WuXi, ZINC, and more

## Installation

Requires [conda](https://docs.conda.io/) with Python 3.10+.

```bash
cd ChemDBSearch/
conda install -c conda-forge rdkit requests click pandas python-dotenv tqdm pydantic pydantic-settings pytest
```

## Quick Start

```bash
# Search for molecules similar to aspirin
python search.py search aspirin.sdf

# Lower threshold for broader results
python search.py search aspirin.sdf -t 0.3

# Custom parameters
python search.py search molecule.sdf -t 0.8 -n 50 -o ./my_results --output-format sdf

# Batch search with multi-molecule SDF
python search.py search multi_query.sdf

# Substructure filter using a separate fragment file
python search.py search aspirin.sdf -sub -sf fragment.sdf

# Verbose mode for debugging
python search.py search molecule.pdb -v
```

## Commands

### `search`

Search Enamine REAL Space for structurally similar molecules.

```
python search.py search INPUT_FILE [OPTIONS]
```

| Option | Short | Default | Description |
|--------|-------|---------|-------------|
| `--threshold` | `-t` | `0.7` | ECFP4 Tanimoto similarity threshold (0.0–1.0) |
| `--max-results` | `-n` | `100` | Maximum number of results |
| `--database` | `-d` | `REALDB-2025-07.smi.anon` | Database to search |
| `--output-dir` | `-o` | `./results` | Output directory |
| `--output-format` | | `both` | Output format: `sdf`, `json`, or `both` |
| `--fingerprint-type` | | `morgan` | Fingerprint type (info only) |
| `--substructure-match` | `-sub` | | Filter by generic substructure (ignores atom types and bond orders) |
| `--exact-substructure-match` | `-esub` | | Filter by exact substructure (preserves atom types and bond orders) |
| `--substructure-file` | `-sf` | | Separate SDF/PDB file to use as substructure filter (with `-sub` or `-esub`) |
| `--verbose` | `-v` | | Enable debug logging |

**Example output:**

```
ChemDB Search - Enamine REAL Space Similarity Search
============================================================

Reading query molecule from: aspirin.sdf
Query SMILES: CC(=O)Oc1ccccc1C(=O)O

Searching database: REALDB-2025-07.smi.anon
Similarity threshold: 0.7
Maximum results: 100

Found 5 similar molecules

Top 5 results:
  1. Similarity: 0.867 | ID: PV-007122236650
     SMILES: CCOC1=CC=CC=C1C(=O)O
  2. Similarity: 0.800 | ID: Z29815314
     SMILES: CCOC(=O)C1=CC=CC=C1OC(=O)C
  ...

SDF output: results/search_results_20260211_154816.sdf
JSON output: results/search_results_20260211_154816.json
```

### `list-databases`

List all available databases on SmallWorld.

```bash
python search.py list-databases
```

### `validate-smiles`

Validate a SMILES string and display molecular properties.

```bash
python search.py validate-smiles "CC(=O)Oc1ccccc1C(=O)O"
```

```
Valid SMILES: CC(=O)Oc1ccccc1C(=O)O
Canonical SMILES: CC(=O)Oc1ccccc1C(=O)O
Isomeric SMILES: CC(=O)Oc1ccccc1C(=O)O
Molecular Formula: C9H8O4
Molecular Weight: 180.04
Number of Atoms: 13
Number of Bonds: 14
```

## Output Formats

### SDF

Output SDF files contain:
- Explicit hydrogen atoms
- MMFF94-optimized 3D coordinates (generated by RDKit)
- Metadata as SD properties: `similarity`, `id`, `molecular_weight`, `molecular_formula`, `atom_alignment_score`

### JSON

```json
{
  "query": {
    "smiles": "CC(=O)Oc1ccccc1C(=O)O",
    "input_file": "aspirin.sdf",
    "timestamp": "20260211_154816"
  },
  "search_params": {
    "threshold": 0.7,
    "max_results": 100,
    "database": "REALDB-2025-07.smi.anon"
  },
  "num_results": 5,
  "results": [
    {
      "smiles": "CCOC1=CC=CC=C1C(=O)O",
      "similarity": 0.867,
      "atom_alignment_score": 0.75,
      "id": "PV-007122236650",
      "molecular_weight": "166.174",
      "molecular_formula": "C9H10O3"
    }
  ]
}
```

## Configuration

Defaults can be overridden via environment variables (prefix `CHEMDB_`) or a `.env` file:

```bash
# .env
CHEMDB_DEFAULT_SIMILARITY_THRESHOLD=0.8
CHEMDB_DEFAULT_MAX_RESULTS=50
CHEMDB_DEFAULT_DATABASE=REALDB-2025-07.smi.anon
CHEMDB_OUTPUT_DIR=./my_results
```

## Project Structure

```
ChemDBSearch/
├── search.py                         # CLI entry point
├── molecule_io.py                    # SDF/PDB reading and SDF/JSON writing
├── fingerprint_engine.py             # Local Tanimoto similarity calculations
├── config.py                         # Pydantic settings management
├── api_clients/
│   ├── __init__.py
│   ├── base_client.py                # Abstract base class for API clients
│   └── smallworld_client.py          # SmallWorld API wrapper
├── tests/
│   └── test_with_aspirin.py          # Unit and integration tests
├── requirements.txt                  # Dependencies
└── .gitignore
```

## Testing

```bash
# Run all tests (including live API integration tests)
python -m pytest tests/ -v

# Skip integration tests (offline)
python -m pytest tests/ -v -k "not integration"
```

## Notes on Similarity Thresholds

ECFP4 Tanimoto scores depend heavily on molecule size:

| Molecule size | Recommended threshold | Reason |
|--------------|----------------------|--------|
| Small (< 10 heavy atoms) | 0.2–0.4 | Sparse fingerprints, low scores even for close analogs |
| Medium (10–30 heavy atoms) | 0.5–0.7 | Typical drug-like molecules |
| Large (> 30 heavy atoms) | 0.7–0.9 | Dense fingerprints, higher baseline similarity |

## How It Works

1. **Read** query molecule(s) from `.sdf` or `.pdb`, converting to isomeric SMILES (preserving stereochemistry from 3D coordinates)
2. **Search** the SmallWorld API in parallel (up to 24 concurrent queries) for each query molecule
3. **Filter** results by Tanimoto threshold and optional substructure match (`-sub`/`-esub`)
4. **Deduplicate** results by SMILES (keeping highest similarity per molecule)
5. **Write** output SDF (with explicit H and MMFF-optimized 3D coordinates) and/or JSON

## Available Databases

Run `python search.py list-databases` for the current list. Common databases include:

| Database | Approx. Size |
|----------|-------------|
| `REAL-Database-22Q1.smi.anon` | 4.5 billion |
| `REALDB-2025-07.smi.anon` | 10.1 billion |
| `wuxi_23Q1.smi.anon` | 15.2 billion |
| `ZINC20-All-25Q2.smi.anon` | 1.9 billion |
| `in-stock-25Q2.smi.anon` | 11 million |

## License

MIT License. See [LICENSE](LICENSE) for details.

SmallWorld API is provided by [UCSF DOCK](https://dock.compbio.ucsf.edu/). Enamine REAL compounds are available for purchase from [Enamine](https://enamine.net/).



